macro(parse_package_external FILE_PATH INDEX)
    file(READ ${FILE_PATH} PACKAGE_EXTERNALS_FILE)
    
    string(JSON EXTERNAL_NAME GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} name)
    string(REGEX REPLACE "[^\.]+\.([^\.]+)" "\\1" EXTERNAL_CPP_NAME ${EXTERNAL_NAME})
    string(REPLACE "~" "_tilde" EXTERNAL_CPP_NAME ${EXTERNAL_CPP_NAME})

    unset(EXTERNAL_AUTHOR_ELEMENTS)
    string(JSON EXTERNAL_AUTHOR_TYPE TYPE ${PACKAGE_EXTERNALS_FILE} ${INDEX} author)
    if(EXTERNAL_AUTHOR_TYPE STREQUAL ARRAY)
        string(JSON EXTERNAL_AUTHOR_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} author)
        if(EXTERNAL_AUTHOR_COUNT)
            math(EXPR EXTERNAL_AUTHOR_MAX_INDEX "${EXTERNAL_AUTHOR_COUNT} - 1")
            foreach(AUTHOR_INDEX RANGE ${EXTERNAL_AUTHOR_MAX_INDEX})
                string(JSON AUTHOR GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} author ${AUTHOR_INDEX})
                list(APPEND EXTERNAL_AUTHOR_ELEMENTS ${AUTHOR})
                unset(AUTHOR)
            endforeach()
        endif()
    elseif(EXTERNAL_AUTHOR_TYPE STREQUAL STRING)
        string(JSON EXTERNAL_AUTHOR GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} author)
    endif()
    
    string(JSON EXTERNAL_DIGEST GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} digest)
    
    unset(EXTERNAL_DESCRIPTION_ELEMENTS)
    string(JSON EXTERNAL_DESCRIPTION_TYPE TYPE ${PACKAGE_EXTERNALS_FILE} ${INDEX} description)
    if(EXTERNAL_DESCRIPTION_TYPE STREQUAL ARRAY)
        string(JSON EXTERNAL_DESCRIPTION_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} description)
        if(EXTERNAL_DESCRIPTION_COUNT)
            math(EXPR EXTERNAL_DESCRIPTION_MAX_INDEX "${EXTERNAL_DESCRIPTION_COUNT} - 1")
            foreach(DESCRIPTION_INDEX RANGE ${EXTERNAL_DESCRIPTION_MAX_INDEX})
                string(JSON DESCRIPTION GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} description ${DESCRIPTION_INDEX})
                list(APPEND EXTERNAL_DESCRIPTION_ELEMENTS ${DESCRIPTION})
                unset(DESCRIPTION)
            endforeach()
            list(JOIN EXTERNAL_DESCRIPTION_ELEMENTS "" EXTERNAL_DESCRIPTION)
        endif()
    elseif(EXTERNAL_DESCRIPTION_TYPE STREQUAL STRING)
        string(JSON EXTERNAL_DESCRIPTION GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} description)
    endif()
    
    unset(EXTERNAL_TAGS)
    string(JSON EXTERNAL_TAG_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} tags)
    if(EXTERNAL_TAG_COUNT)
        math(EXPR EXTERNAL_TAG_MAX_INDEX "${EXTERNAL_TAG_COUNT} - 1")
        foreach(TAG_INDEX RANGE ${EXTERNAL_TAG_MAX_INDEX})
            string(JSON TAG GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} tags ${TAG_INDEX})
            list(APPEND EXTERNAL_TAGS ${TAG})
            unset(TAG)
        endforeach()
    endif()
    
    unset(EXTERNAL_RELATED)
    string(JSON EXTERNAL_RELATED_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} related)
    if(EXTERNAL_RELATED_COUNT)
        math(EXPR EXTERNAL_RELATED_MAX_INDEX "${EXTERNAL_RELATED_COUNT} - 1")
        foreach(RELATED_INDEX RANGE ${EXTERNAL_RELATED_MAX_INDEX})
            string(JSON RELATED GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} related ${RELATED_INDEX})
            list(APPEND EXTERNAL_RELATED ${RELATED})
            unset(RELATED)
        endforeach()
    endif()
    
    unset(EXTERNAL_INLETS)
    string(JSON EXTERNAL_INLET_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} inlets)
    if(EXTERNAL_INLET_COUNT)
        math(EXPR EXTERNAL_INLET_MAX_INDEX "${EXTERNAL_INLET_COUNT} - 1")
        foreach(INLET_INDEX RANGE ${EXTERNAL_INLET_MAX_INDEX})
            string(JSON INLET GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} inlets ${INLET_INDEX})
            list(APPEND EXTERNAL_INLETS ${INLET})
            unset(INLET)
        endforeach()
    endif()
    
    unset(EXTERNAL_OUTLETS)
    string(JSON EXTERNAL_OUTLET_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} outlets)
    if(EXTERNAL_OUTLET_COUNT)
        math(EXPR EXTERNAL_OUTLET_MAX_INDEX "${EXTERNAL_OUTLET_COUNT} - 1")
        foreach(OUTLET_INDEX RANGE ${EXTERNAL_OUTLET_MAX_INDEX})
            string(JSON OUTLET GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} outlets ${OUTLET_INDEX})
            list(APPEND EXTERNAL_OUTLETS ${OUTLET})
            unset(OUTLET)
        endforeach()
    endif()

    unset(EXTERNAL_ATTRIBUTES)
    string(JSON EXTERNAL_ATTRIBUTE_COUNT LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} attributes)
    if(EXTERNAL_ATTRIBUTE_COUNT)
        math(EXPR EXTERNAL_ATTRIBUTE_MAX_INDEX "${EXTERNAL_ATTRIBUTE_COUNT} - 1")
        foreach(ATTRIBUTE_INDEX RANGE ${EXTERNAL_ATTRIBUTE_MAX_INDEX})
            string(JSON ATTRIBUTE GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} attributes ${ATTRIBUTE_INDEX})
            list(APPEND EXTERNAL_ATTRIBUTES ${ATTRIBUTE})
            unset(ATTRIBUTE)
        endforeach()
    endif()
    
    string(JSON EXTERNAL_OPERATION_TYPE ERROR_VARIABLE ERROR GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} operation type)
    if(EXTERNAL_OPERATION_TYPE MATCHES NOTFOUND)
        unset(EXTERNAL_OPERATION_TYPE)
        unset(EXTERNAL_OPERATION_INPUTS)
        unset(EXTERNAL_OPERATION_OUTPUTS)
    elseif(EXTERNAL_OPERATION_TYPE STREQUAL sample)
        string(JSON EXTERNAL_OPERATION_INPUTS GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} operation inputs)
        string(JSON EXTERNAL_OPERATION_OUTPUTS GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} operation outputs)
    else()
        unset(EXTERNAL_OPERATION_INPUTS)
        unset(EXTERNAL_OPERATION_OUTPUTS)
    endif()

    string(JSON EXTERNAL_DOCUMENTATION_TYPE ERROR_VARIABLE ERROR GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} documentation)
    if(EXTERNAL_DOCUMENTATION_TYPE MATCHES NOTFOUND)
        set(EXTERNAL_DOCUMENTATION_TYPE generated)
    endif()

    unset(EXTERNAL_ADDITIONAL_SOURCE_FILES)
    string(JSON EXTERNAL_ADDITIONAL_SOURCE_FILES_COUNT ERROR_VARIABLE ERROR LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} additionalsourcefiles)
    if(NOT EXTERNAL_ADDITIONAL_SOURCE_FILES_COUNT MATCHES NOTFOUND AND EXTERNAL_ADDITIONAL_SOURCE_FILES_COUNT GREATER 0)
        math(EXPR EXTERNAL_ADDITIONAL_SOURCE_FILES_MAX_INDEX "${EXTERNAL_ADDITIONAL_SOURCE_FILES_COUNT} - 1")
        foreach(SOURCE_FILE_INDEX RANGE ${EXTERNAL_ADDITIONAL_SOURCE_FILES_MAX_INDEX})
            string(JSON SOURCE_FILE_NAME GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} additionalsourcefiles ${SOURCE_FILE_INDEX})
            string(PREPEND SOURCE_FILE_NAME ${CMAKE_CURRENT_SOURCE_DIR}/source/)
            list(APPEND EXTERNAL_ADDITIONAL_SOURCE_FILES ${SOURCE_FILE_NAME})
            unset(SOURCE_FILE_NAME)
        endforeach()
    endif()
    
    unset(EXTERNAL_LIBRARIES)
    unset(EXTERNAL_LIBRARIES_STRING)
    unset(EXTERNAL_LINK_LIBRARIES)
    string(JSON EXTERNAL_LINK_LIBRARIES_COUNT ERROR_VARIABLE ERROR LENGTH ${PACKAGE_EXTERNALS_FILE} ${INDEX} linklibraries)
    if(NOT EXTERNAL_LINK_LIBRARIES_COUNT MATCHES NOTFOUND AND EXTERNAL_LINK_LIBRARIES_COUNT GREATER 0)
        math(EXPR EXTERNAL_LINK_LIBRARIES_MAX_INDEX "${EXTERNAL_LINK_LIBRARIES_COUNT} - 1")
        foreach(LIBRARY_INDEX RANGE ${EXTERNAL_LINK_LIBRARIES_MAX_INDEX})
            string(JSON LIBRARY_NAME GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} linklibraries ${LIBRARY_INDEX} name)
            list(APPEND EXTERNAL_LIBRARIES ${LIBRARY_NAME})
            unset(LIBRARY_NAME)
            string(JSON LIBRARY_LINKNAME GET ${PACKAGE_EXTERNALS_FILE} ${INDEX} linklibraries ${LIBRARY_INDEX} linkname)
            list(APPEND EXTERNAL_LINK_LIBRARIES ${LIBRARY_LINKNAME})
            unset(LIBRARY_LINKNAME)
        endforeach()
        list(JOIN EXTERNAL_LIBRARIES ", " EXTERNAL_LIBRARIES_STRING)
        string(PREPEND EXTERNAL_LIBRARIES_STRING " linking: [")
        string(APPEND EXTERNAL_LIBRARIES_STRING "]")
    endif()
endmacro()
